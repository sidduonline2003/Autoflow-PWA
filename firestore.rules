rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() { return request.auth != null; }
    function isOrgMember(orgId) { return isAuth() && request.auth.token.orgId == orgId; }
    function isAdmin(orgId) { return isOrgMember(orgId) && request.auth.token.role == 'admin'; }
    function isClient(orgId, clientId) { return isOrgMember(orgId) && request.auth.token.role == 'client' && request.auth.token.clientId == clientId; }
    function isTeamMember(orgId) { return isOrgMember(orgId) && request.auth.token.role in ['admin', 'crew', 'editor', 'data-manager']; }
    function isFinanceAdmin(orgId) { return isOrgMember(orgId) && request.auth.token.role in ['admin', 'accountant']; }

    // --- Security Rules ---
    match /organizations/{orgId} {
      allow create: if isAuth();
      allow read, update: if isAdmin(orgId);
      allow delete: if false;

      // Rules for Clients
      match /clients/{clientId} {
        allow list: if isAdmin(orgId);
        allow read, write: if isAdmin(orgId) || isClient(orgId, clientId);
      }
      match /clients/{clientId}/{documents=**} {
        allow read, write: if isAdmin(orgId) || isClient(orgId, clientId);
      }
      
      // Rules for Team Members
      match /team/{memberId} {
        allow write: if isAdmin(orgId);
        allow read, list: if isTeamMember(orgId);
        
        // Salary Profile - Only the member or finance admins can read
        match /salaryProfile/{profileId} {
          allow write: if isFinanceAdmin(orgId);
          allow read: if isFinanceAdmin(orgId) || (isTeamMember(orgId) && memberId == request.auth.uid);
        }
      }

      // Rules for Deleted Team Members (admin recycle bin)
      match /deleted_team/{memberId} {
        allow read, list: if isAdmin(orgId);
        allow write: if false;
        allow delete: if false;
      }

      // Rules for Invitations
      match /invites/{inviteId} {
        allow create, read: if isAdmin(orgId);
        allow update, delete: if false;
      }

      // Rules for Leave Requests
      match /leaveRequests/{requestId} {
        // A team member can create their own leave request if the data is valid.
        allow create: if isTeamMember(orgId) && request.resource.data.userId == request.auth.uid;
        
        // Admins can read/update all requests. Team members can read their own.
        allow read, update: if isAdmin(orgId) || (isTeamMember(orgId) && resource.data.userId == request.auth.uid);
        
        // Admins can list all requests. Team members can query for their own requests.
        allow list: if isAdmin(orgId) || (isTeamMember(orgId) && request.query.where.lhs == 'userId' && request.query.where.rhs == request.auth.uid);
      }

      // --- Schedules Collection ---
      match /schedules/{scheduleId} {
        // Only admins can create or delete schedule entries (for leaves/events)
        allow create, delete: if isAdmin(orgId);
        // Admins can read all schedule entries
        allow read: if isAdmin(orgId);
        // Team members can read their own schedules
        allow read: if isTeamMember(orgId) && resource.data.userId == request.auth.uid;
        // Admins can list all
        allow list: if isAdmin(orgId);
        // Team members can list only their own
        allow list: if isTeamMember(orgId)
                    && request.query.where.lhs == 'userId' 
                    && request.query.where.op == '==' 
                    && request.query.where.rhs == request.auth.uid;
      }
      
      // Rules for Salary Management
      match /salaryRuns/{runId} {
        // Only finance admins can write
        allow write: if isFinanceAdmin(orgId);
        // Only finance admins can list all salary runs
        allow list, read: if isFinanceAdmin(orgId);
        
        // Payslips collection
        match /payslips/{payslipId} {
          // Finance admins can do anything
          allow write: if isFinanceAdmin(orgId);
          // Finance admins can read any payslip
          allow read, list: if isFinanceAdmin(orgId);
          // Team members can only read their own payslips if they're published or paid
          allow read: if isTeamMember(orgId) && 
                        payslipId == request.auth.uid && 
                        (resource.data.status == 'PUBLISHED' || resource.data.status == 'PAID');
        }
      }
    }
    
    // Public rule for non-authenticated users to read a specific invite
    match /organizations/{orgId}/invites/{inviteId} {
        allow get: if !isAuth();
    }
  }
}
